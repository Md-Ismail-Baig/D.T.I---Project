{% extends "base.html" %}
{% block title %}Users{% endblock %}

{% block content %}
<h2>User Management</h2>

<!-- ================= CREATE USER BUTTON ================= -->
<div style="margin-bottom:15px;">
    <a href="{{ url_for('admin.create_user') }}" class="btn" style="background:#28a745; color:white; padding:6px 12px; border-radius:4px;">
        ➕ Create New User
    </a>

    <a href="{{ url_for('admin.view_users') }}" class="btn">
        View All Users
    </a>
    
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn">
        ⬅ Back to Dashboard
    </a>
</div>

<!-- ================= PROFILE WARNING ================= -->
{% if role in ['state_admin','municipal_admin'] and (not profile_location.state_id or not profile_location.city_id) %}
<div style="background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:6px; margin-bottom:15px;">
    ⚠️ Your profile location is incomplete. Filtering will rely on defaults.
    <a href="{{ url_for('profile.update_profile') }}">Complete profile</a>
</div>
{% endif %}

<!-- ================= FILTER BAR ================= -->
<div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
    {% if role == 'super_admin' %}
    <select id="state_filter">
        <option value="">--Select State--</option>
        {% for s in states %}
            <option value="{{ s.state_id }}">{{ s.name }}</option>
        {% endfor %}
    </select>
    {% endif %}

    {% if role in ['super_admin','state_admin'] %}
    <select id="city_filter">
        <option value="">--Select City--</option>
    </select>
    {% endif %}

    {% if role in ['super_admin','state_admin','municipal_admin'] %}
    <select id="ward_filter">
        <option value="">--Select Ward--</option>
    </select>
    {% endif %}

    <input type="text" id="search_input" placeholder="Search by name or mobile" style="min-width:220px;">
</div>

<!-- ================= USERS TABLE ================= -->
<table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse;">
    <thead style="background:#f0f0f0;">
        <tr>
            <th>Name</th>
            <th>Mobile</th>
            <th>Email</th>
            <th>Role</th>
            <th>Ward</th>
            <th>City</th>
            <th>State</th>
            <th>Verified</th>
            <th>Assisted</th>
        </tr>
    </thead>
    <tbody id="users_table">
        {% for u in users %}
        <tr>
            <td>{{ u.name }}</td>
            <td>{{ u.mobile }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>{{ u.ward_name or '-' }}</td>
            <td>{{ u.city_name or '-' }}</td>
            <td>{{ u.state_name or '-' }}</td>
            <td>{{ 'Yes' if u.verified else 'No' }}</td>
            <td>{{ 'Yes' if u.assisted_signup else 'No' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="9">No users found.</td></tr>
        {% endfor %}
    </tbody>
</table>

<!-- ================= PROFILE CONTEXT ================= -->
<script>
const PROFILE = {
    state_id: "{{ profile_location.state_id or '' }}",
    city_id:  "{{ profile_location.city_id or '' }}"
};

document.addEventListener("DOMContentLoaded", () => {
    const state  = document.getElementById("state_filter");
    const city   = document.getElementById("city_filter");
    const ward   = document.getElementById("ward_filter");
    const search = document.getElementById("search_input");
    const table  = document.getElementById("users_table");

    // ---------- LOAD USERS ----------
    function loadUsers() {
        const params = new URLSearchParams();
        state?.value && params.append("state_id", state.value);
        city?.value  && params.append("city_id", city.value);
        ward?.value  && params.append("ward_id", ward.value);
        search.value.trim() && params.append("search", search.value.trim());

        fetch(`/admin/users/filter?${params.toString()}`)
            .then(r => r.json())
            .then(d => {
                table.innerHTML = "";
                if (!d.users.length) {
                    table.innerHTML = "<tr><td colspan='9'>No users found.</td></tr>";
                    return;
                }
                d.users.forEach(u => {
                    table.innerHTML += `
                        <tr>
                            <td>${u.name}</td>
                            <td>${u.mobile}</td>
                            <td>${u.email}</td>
                            <td>${u.role}</td>
                            <td>${u.ward_name || '-'}</td>
                            <td>${u.city_name || '-'}</td>
                            <td>${u.state_name || '-'}</td>
                            <td>${u.verified ? 'Yes' : 'No'}</td>
                            <td>${u.assisted_signup ? 'Yes' : 'No'}</td>
                        </tr>`;
                });
            });
    }

    // ---------- LOAD CITIES ----------
    function loadCities(stateId, selectedCity=null) {
        if (!city) return;
        city.innerHTML = "<option value=''>--Select City--</option>";
        ward && (ward.innerHTML = "<option value=''>--Select Ward--</option>");

        fetch(`/admin/get_cities?state_id=${stateId}`)
            .then(r => r.json())
            .then(d => {
                d.cities.forEach(c =>
                    city.innerHTML += `<option value="${c.city_id}">${c.name}</option>`
                );
                if (selectedCity) {
                    city.value = selectedCity;
                    loadWards(selectedCity);
                }
                loadUsers();
            });
    }

    // ---------- LOAD WARDS ----------
    function loadWards(cityId, selectedWard=null) {
        if (!ward) return;
        ward.innerHTML = "<option value=''>--Select Ward--</option>";

        fetch(`/admin/get_wards?city_id=${cityId}`)
            .then(r => r.json())
            .then(d => {
                d.wards.forEach(w =>
                    ward.innerHTML += `<option value="${w.ward_id}">${w.name}</option>`
                );
                if (selectedWard) ward.value = selectedWard;
                loadUsers();
            });
    }

    // ---------- INITIALIZE ----------

    if (state && PROFILE.state_id) {
        // super_admin
        state.value = PROFILE.state_id;
        loadCities(PROFILE.state_id, PROFILE.city_id);
    }

    else if (!state && city && PROFILE.state_id) {
        // state_admin
        loadCities(PROFILE.state_id);
    }

    else if (!state && !city && ward && PROFILE.city_id) {
        // municipal_admin
        loadWards(PROFILE.city_id);
    }

    else {
        loadUsers();
    }


    // ---------- EVENT LISTENERS ----------
    state?.addEventListener("change", () => {
        state.value ? loadCities(state.value) : loadUsers();
    });
    city?.addEventListener("change", () => {
        city.value ? loadWards(city.value) : loadUsers();
    });
    ward?.addEventListener("change", loadUsers);
    search.addEventListener("input", loadUsers);
});
</script>
{% endblock %}
