{% extends "base.html" %}
{% block title %}Create User{% endblock %}

{% block content %}
<h1>Create New User</h1>

<form method="POST" id="createUserForm">

    <!-- Name -->
    <label>Name:</label>
    <input type="text" name="name" required>

    <!-- Email -->
    <label>Email:</label>
    <input type="email" name="email">

    <!-- Mobile -->
    <label>Mobile:</label>
    <input type="text" name="mobile" required>

    <!-- Password -->
    <label>Password:</label>
    <input type="password" name="password" required>

    <!-- Role -->
    <label>Role:</label>
    <select name="role" required>
        {% for r in allowed_roles %}
            <option value="{{ r }}">{{ r.replace('_',' ').title() }}</option>
        {% endfor %}
    </select>

<!-- ================= STATE ================= -->
<label>State:</label>

{% if role == "super_admin" %}
    <select name="state_id" id="stateSelect" required>
        <option value="" disabled selected>-- Select State --</option>
        {% for state in states %}
            <option value="{{ state.state_id }}">
                {{ state.name }}
            </option>
        {% endfor %}
    </select>

{% else %}
    <!-- Fixed State (state_admin & municipal_admin) -->
    <input type="text"
           value="{{ profile_location.state_name }} (Your State)"
           disabled>
    <input type="hidden"
           name="state_id"
           value="{{ profile_location.state_id }}">
{% endif %}



<!-- ================= CITY ================= -->
<label>City:</label>

{% if role == "super_admin" %}
    <select name="city_id" id="citySelect" required>
        <option value="" disabled selected>-- Select City --</option>
        {% for city in cities %}
            <option value="{{ city.city_id }}"
                    data-state="{{ city.state_id }}">
                {{ city.name }}
            </option>
        {% endfor %}
    </select>

{% elif role == "state_admin" %}
    <select name="city_id" id="citySelect" required>
        <option value="" disabled selected>-- Select City --</option>
        {% for city in cities %}
            <option value="{{ city.city_id }}">
                {{ city.name }}
            </option>
        {% endfor %}
    </select>

{% else %}
    <!-- Fixed City (municipal_admin) -->
    <input type="text"
           value="{{ profile_location.city_name }} (Your City)"
           disabled>
    <input type="hidden"
           name="city_id"
           value="{{ profile_location.city_id }}">
{% endif %}



<!-- ================= WARD ================= -->
<label>Ward:</label>

<select name="ward_id" id="wardSelect" required>
    <option value="" disabled selected>-- Select Ward --</option>

    {% if role == "municipal_admin" %}
        {% for ward in wards %}
            <option value="{{ ward.ward_id }}">
                {{ ward.name }}
            </option>
        {% endfor %}
    {% else %}
        {% for ward in wards %}
            <option value="{{ ward.ward_id }}"
                    data-city="{{ ward.city_id }}">
                {{ ward.name }}
            </option>
        {% endfor %}
    {% endif %}
</select>



<button type="submit" class="btn">Create User</button>
</form>

<a href="{{ url_for('admin.view_users') }}" class="btn">
    â¬… Back to Users List
</a>

<!-- ================= JAVASCRIPT ================= -->
<script>
const stateSelect = document.getElementById("stateSelect");
const citySelect = document.getElementById("citySelect");
const wardSelect = document.getElementById("wardSelect");

/* Filter cities when state changes (super_admin only) */
function filterCities() {
    const stateId = stateSelect.value;
    for (let opt of citySelect.options) {
        opt.style.display =
            (opt.value === "" || opt.dataset.state === stateId)
            ? "block"
            : "none";
    }
    citySelect.value = "";
    filterWards();
}

/* Filter wards when city changes */
function filterWards() {
    const cityId = citySelect.value;
    for (let opt of wardSelect.options) {
        opt.style.display =
            (opt.value === "" || opt.dataset.city === cityId)
            ? "block"
            : "none";
    }
    wardSelect.value = "";
}

stateSelect?.addEventListener("change", filterCities);
citySelect?.addEventListener("change", filterWards);
</script>

{% endblock %}
