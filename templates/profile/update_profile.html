{% extends "base.html" %}
{% block title %}Update Profile{% endblock %}

{% block content %}
<h1>Update Profile</h1>

<form method="POST">
    <label>Name:</label>
    <input type="text" name="name" value="{{ user.name }}" required><br><br>

    <label>Email:</label>
    <input type="email" name="email" value="{{ user.email }}"><br><br>

    <label>Mobile:</label>
    <input type="text" name="mobile" value="{{ user.mobile }}" required><br><br>

    <!-- STATE -->
    <label>State:</label>
    <select id="state_id" name="state_id">
        <option value="">Select State</option>
        {% for s in states %}
            <option value="{{ s.state_id }}" {% if s.state_id == user.state_id %}selected{% endif %}>
                {{ s.name }}
            </option>
        {% endfor %}
    </select><br><br>

    <!-- CITY -->
    <label>City:</label>
    <select id="city_id" name="city_id" data-selected="{{ user.city_id }}">
        <option value="">Select City</option>
    </select><br><br>

    <!-- WARD -->
    <label>Ward:</label>
    <select id="ward_id" name="ward_id" data-selected="{{ user.ward_id }}">
        <option value="">Select Ward</option>
    </select><br><br>

    <button type="submit">Update</button>
</form>

<a href="{{ url_for('profile.profile_page') }}">Back to Profile</a>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const state = document.getElementById("state_id");
    const city  = document.getElementById("city_id");
    const ward  = document.getElementById("ward_id");

    function loadCities(selectedState, selectedCity=null) {
        if (!selectedState) return;
        city.innerHTML = "<option value=''>Select City</option>";
        ward.innerHTML = "<option value=''>Select Ward</option>";

        fetch(`/profile/api/cities?state_id=${selectedState}`)
            .then(r => r.json())
            .then(d => {
                d.cities.forEach(c => {
                    city.innerHTML += `<option value="${c.city_id}">${c.name}</option>`;
                });
                if (selectedCity) city.value = selectedCity;
                if (selectedCity) loadWards(selectedCity, ward.getAttribute("data-selected"));
            });
    }

    function loadWards(selectedCity, selectedWard=null) {
        if (!selectedCity) return;
        ward.innerHTML = "<option value=''>Select Ward</option>";

        fetch(`/profile/api/wards?city_id=${selectedCity}`)
            .then(r => r.json())
            .then(d => {
                d.wards.forEach(w => {
                    ward.innerHTML += `<option value="${w.ward_id}">${w.name}</option>`;
                });
                if (selectedWard) ward.value = selectedWard;
            });
    }

    // ---------- INITIAL BOOTSTRAP ----------
    if (state.value) {
        loadCities(state.value, city.getAttribute("data-selected"));
    }

    // ---------- EVENTS ----------
    state.addEventListener("change", () => {
        loadCities(state.value);
    });

    city.addEventListener("change", () => {
        loadWards(city.value);
    });
});
</script>

{% endblock %}
